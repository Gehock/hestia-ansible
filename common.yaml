---
- name: Common setup
  hosts: all

  vars:
    users:
      - sami
      - root

  tasks:
  - name: Install packages
    ansible.builtin.apt:
      name:
        - zsh
        - git
        - tmux
        - byobu
        - ufw
        - fail2ban
      update_cache: true
  - name: Set git default branch
    community.general.git_config:
      scope: system
      name: init.defaultBranch
      value: main
  - name: Create users
    ansible.builtin.user:
      name: sami
      shell: /usr/bin/zsh
  - name: Set git configs
    become: true
    become_user: "{{ item.0 }}"
    community.general.git_config:
      scope: global
      name: "{{ item.1.config }}"
      value: "{{ item.1.value }}"
    loop: "{{ git_config_users|product(git_configs)|list }}"
    vars:
      git_configs:
      - { config: user.name,  value: Sami Laine }
      - { config: user.email, value: sami.v.laine@gmail.com }
      git_config_users:
      - sami
      - root
  - name: Add SSH keys
    ansible.posix.authorized_key:
      user: "{{ item }}"
      key: "{{ lookup('file', 'files/pubkeys/{{ item }}') }}"
      exclusive: True
    loop: "{{ users }}"
  - name: Set vim as editor
    community.general.alternatives:
      name: editor
      path: /usr/bin/vim.basic
  - name: Enable ufw
    community.general.ufw:
      state: enabled
      policy: reject
  - name: Allow SSH
    community.general.ufw:
      rule: allow
      name: OpenSSH
  - name: Start fail2ban
    ansible.builtin.systemd:
      state: started
      enabled: yes
      name: fail2ban
